---
# Development mode installation - Clone repo, build from source, link globally

- name: Create code directory
  ansible.builtin.file:
    path: "{{ openclaw_code_dir }}"
    state: directory
    owner: "{{ openclaw_user }}"
    group: "{{ openclaw_user }}"
    mode: '0755'

- name: Check if openclaw repository already exists
  ansible.builtin.stat:
    path: "{{ openclaw_repo_dir }}/.git"
  register: openclaw_repo_exists

- name: Clone openclaw repository
  ansible.builtin.git:
    repo: "{{ openclaw_repo_url }}"
    dest: "{{ openclaw_repo_dir }}"
    version: "{{ openclaw_repo_branch }}"
    update: true
  become: true
  become_user: "{{ openclaw_user }}"
  when: not openclaw_repo_exists.stat.exists

- name: Pull latest changes if repo exists
  ansible.builtin.git:
    repo: "{{ openclaw_repo_url }}"
    dest: "{{ openclaw_repo_dir }}"
    version: "{{ openclaw_repo_branch }}"
    update: true
  become: true
  become_user: "{{ openclaw_user }}"
  when: openclaw_repo_exists.stat.exists
  register: git_pull_result

- name: Install dependencies with pnpm
  ansible.builtin.shell:
    cmd: pnpm install
    chdir: "{{ openclaw_repo_dir }}"
    executable: /bin/bash
  become: true
  become_user: "{{ openclaw_user }}"
  environment:
    PNPM_HOME: "{{ openclaw_home }}/.local/share/pnpm"
    PATH: "{{ openclaw_home }}/.local/bin:/usr/local/bin:/usr/bin:/bin"
    HOME: "{{ openclaw_home }}"
  register: pnpm_install_result
  changed_when: "'Already up to date' not in pnpm_install_result.stdout"

- name: Build openclaw from source
  ansible.builtin.shell:
    cmd: pnpm build
    chdir: "{{ openclaw_repo_dir }}"
    executable: /bin/bash
  become: true
  become_user: "{{ openclaw_user }}"
  environment:
    PNPM_HOME: "{{ openclaw_home }}/.local/share/pnpm"
    PATH: "{{ openclaw_home }}/.local/bin:/usr/local/bin:/usr/bin:/bin"
    HOME: "{{ openclaw_home }}"
  register: pnpm_build_result
  changed_when: true  # Build always changes dist/ directory

- name: Check if dist directory exists
  ansible.builtin.stat:
    path: "{{ openclaw_repo_dir }}/dist"
  register: dist_dir

- name: Fail if build didn't create dist directory
  ansible.builtin.fail:
    msg: "Build failed - dist directory not found"
  when: not dist_dir.stat.exists

- name: Remove existing global openclaw symlink (if any)
  ansible.builtin.file:
    path: "{{ openclaw_home }}/.local/bin/openclaw"
    state: absent

- name: Create symlink to openclaw binary
  ansible.builtin.file:
    src: "{{ openclaw_repo_dir }}/bin/openclaw.js"
    dest: "{{ openclaw_home }}/.local/bin/openclaw"
    state: link
    owner: "{{ openclaw_user }}"
    group: "{{ openclaw_user }}"
    force: true

- name: Make openclaw binary executable
  ansible.builtin.file:
    path: "{{ openclaw_repo_dir }}/bin/openclaw.js"
    mode: '0755'
    owner: "{{ openclaw_user }}"
    group: "{{ openclaw_user }}"

