---
# macOS-specific Tailscale installation (Homebrew Cask)

- name: Check if Tailscale is already installed (macOS)
  ansible.builtin.stat:
    path: /Applications/Tailscale.app
  register: tailscale_app_macos

- name: Install Tailscale via Homebrew Cask (macOS)
  community.general.homebrew_cask:
    name: tailscale
    state: present
  environment:
    PATH: "/opt/homebrew/bin:{{ ansible_env.PATH }}"
  when: not tailscale_app_macos.stat.exists

- name: Check if Tailscale is running (macOS)
  ansible.builtin.command: /Applications/Tailscale.app/Contents/MacOS/Tailscale status --json
  register: tailscale_status_macos
  changed_when: false
  failed_when: false

- name: Display Tailscale setup instructions (macOS)
  ansible.builtin.debug:
    msg:
      - "============================================"
      - "Tailscale installed on macOS"
      - "============================================"
      - ""
      - "To connect this Mac to your Tailnet:"
      - ""
      - "Option 1 - GUI:"
      - "  1. Open Tailscale from Applications"
      - "  2. Click 'Log in' and follow the web flow"
      - ""
      - "Option 2 - CLI:"
      - "  sudo /Applications/Tailscale.app/Contents/MacOS/Tailscale up"
      - ""
      - "With auth key:"
      - "  sudo /Applications/Tailscale.app/Contents/MacOS/Tailscale up --authkey tskey-auth-xxxxx"
      - ""
      - "Get auth key from: https://login.tailscale.com/admin/settings/keys"
  when: tailscale_status_macos.rc != 0
