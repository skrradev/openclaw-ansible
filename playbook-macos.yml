---
- name: Install OpenClaw on macOS
  hosts: localhost
  connection: local
  become: true

  vars:
    ansible_python_interpreter: /usr/bin/python3

  pre_tasks:
    - name: Check if running as root
      ansible.builtin.command: id -u
      register: user_id
      changed_when: false
      become: false

    - name: Set fact for root user
      ansible.builtin.set_fact:
        is_root: "{{ user_id.stdout == '0' }}"

    - name: Install Ansible collections
      ansible.builtin.command: ansible-galaxy collection install -r requirements.yml
      args:
        chdir: "{{ playbook_dir }}"
      delegate_to: localhost
      become: false
      run_once: true
      changed_when: false

    - name: Check if Homebrew is installed
      ansible.builtin.stat:
        path: /opt/homebrew/bin/brew
      register: homebrew_check

    - name: Install Homebrew (macOS)
      ansible.builtin.shell: |
        NONINTERACTIVE=1 /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
      args:
        creates: /opt/homebrew/bin/brew
      when: not homebrew_check.stat.exists
      become: false

    - name: Add Homebrew to PATH for current session
      ansible.builtin.set_fact:
        ansible_env: "{{ ansible_env | combine({'PATH': '/opt/homebrew/bin:' + (ansible_env.PATH | default(lookup('env', 'PATH')))}) }}"

  roles:
    - macos
